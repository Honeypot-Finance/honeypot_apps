!function(e,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((e="undefined"!=typeof globalThis?globalThis:e||self).Datafeeds={})}(this,function(e){"use strict";function s(e){return void 0===e?"":"string"==typeof e?e:e.message}class t{constructor(e,s){this._datafeedUrl=e,this._requester=s}getBars(e,t,r){let i={symbol:e.ticker||"",resolution:t,from:r.from,to:r.to};return void 0!==r.countBack&&(i.countback=r.countBack),void 0!==e.currency_code&&(i.currencyCode=e.currency_code),void 0!==e.unit_id&&(i.unitId=e.unit_id),new Promise((e,t)=>{this._requester.sendRequest(this._datafeedUrl,"history",i).then(s=>{if("ok"!==s.s&&"no_data"!==s.s)return void t(s.errmsg);let r=[],i={noData:!1};if("no_data"===s.s)i.noData=!0,i.nextTime=s.nextTime;else{let e=void 0!==s.v,t=void 0!==s.o;for(let i=0;i<s.t.length;++i){let o={time:1e3*s.t[i],close:parseFloat(s.c[i]),open:parseFloat(s.c[i]),high:parseFloat(s.c[i]),low:parseFloat(s.c[i])};t&&(o.open=parseFloat(s.o[i]),o.high=parseFloat(s.h[i]),o.low=parseFloat(s.l[i])),e&&(o.volume=parseFloat(s.v[i])),r.push(o)}}e({bars:r,meta:i})}).catch(e=>{let r=s(e);console.warn(`HistoryProvider: getBars() failed, error=${r}`),t(r)})})}}class r{constructor(e,s){this._subscribers={},this._requestsPending=0,this._historyProvider=e,setInterval(this._updateData.bind(this),s)}subscribeBars(e,s,t,r){this._subscribers.hasOwnProperty(r)||(this._subscribers[r]={lastBarTime:null,listener:t,resolution:s,symbolInfo:e},e.name)}unsubscribeBars(e){delete this._subscribers[e]}_updateData(){if(!(this._requestsPending>0))for(let e in this._requestsPending=0,this._subscribers)this._requestsPending+=1,this._updateDataForSubscriber(e).then(()=>{this._requestsPending-=1,this._requestsPending}).catch(e=>{this._requestsPending-=1,s(e),this._requestsPending})}_updateDataForSubscriber(e){var s;let t=this._subscribers[e],r=parseInt((Date.now()/1e3).toString()),i=r-24*("D"===(s=t.resolution)||"1D"===s?10:"M"===s||"1M"===s?310:"W"===s||"1W"===s?70:10*parseInt(s)/1440)*3600;return this._historyProvider.getBars(t.symbolInfo,t.resolution,{from:i,to:r,countBack:2,firstDataRequest:!1}).then(s=>{this._onSubscriberDataReceived(e,s)})}_onSubscriberDataReceived(e,s){if(!this._subscribers.hasOwnProperty(e))return;let t=s.bars;if(0===t.length)return;let r=t[t.length-1],i=this._subscribers[e];if(null===i.lastBarTime||!(r.time<i.lastBarTime)){if(null!==i.lastBarTime&&r.time>i.lastBarTime){if(t.length<2)throw Error("Not enough bars in history for proper pulse update. Need at least 2.");let e=t[t.length-2];i.listener(e)}i.lastBarTime=r.time,i.listener(r)}}}class i{constructor(e){this._subscribers={},this._requestsPending=0,this._quotesProvider=e,setInterval(this._updateQuotes.bind(this,1),1e4),setInterval(this._updateQuotes.bind(this,0),6e4)}subscribeQuotes(e,s,t,r){this._subscribers[r]={symbols:e,fastSymbols:s,listener:t}}unsubscribeQuotes(e){delete this._subscribers[e]}_updateQuotes(e){if(!(this._requestsPending>0))for(let t in this._subscribers){this._requestsPending++;let r=this._subscribers[t];this._quotesProvider.getQuotes(1===e?r.fastSymbols:r.symbols).then(e=>{this._requestsPending--,this._subscribers.hasOwnProperty(t)&&(r.listener(e),this._requestsPending)}).catch(e=>{this._requestsPending--,s(e),this._requestsPending})}}}function o(e,s,t,r){let i=e[s];return Array.isArray(i)&&(!r||Array.isArray(i[0]))?i[t]:i}function n(e,s,t){return e+(void 0!==s?"_%|#|%_"+s:"")+(void 0!==t?"_%|#|%_"+t:"")}class a{constructor(e,s,t){this._exchangesList=["NYSE","FOREX","AMEX"],this._symbolsInfo={},this._symbolsList=[],this._datafeedUrl=e,this._datafeedSupportedResolutions=s,this._requester=t,this._readyPromise=this._init(),this._readyPromise.catch(e=>{console.error(`SymbolsStorage: Cannot init, error=${e.toString()}`)})}resolveSymbol(e,s,t){return this._readyPromise.then(()=>{let r=this._symbolsInfo[n(e,s,t)];return void 0===r?Promise.reject("invalid symbol"):Promise.resolve(r)})}searchSymbols(e,s,t,r){return this._readyPromise.then(()=>{let i=[],o=0===e.length;for(let r of(e=e.toUpperCase(),this._symbolsList)){let n=this._symbolsInfo[r];if(void 0===n||t.length>0&&n.type!==t||s&&s.length>0&&n.exchange!==s)continue;let a=n.name.toUpperCase().indexOf(e),u=n.description.toUpperCase().indexOf(e);if((o||a>=0||u>=0)&&!i.some(e=>e.symbolInfo===n)){let e=a>=0?a:8e3+u;i.push({symbolInfo:n,weight:e})}}return Promise.resolve(i.sort((e,s)=>e.weight-s.weight).slice(0,r).map(e=>{let s=e.symbolInfo;return{symbol:s.name,full_name:s.full_name,description:s.description,exchange:s.exchange,params:[],type:s.type,ticker:s.name}}))})}_init(){let e=[],s={};for(let t of this._exchangesList)s[t]||(s[t]=!0,e.push(this._requestExchangeData(t)));return Promise.all(e).then(()=>{this._symbolsList.sort()})}_requestExchangeData(e){return new Promise((t,r)=>{this._requester.sendRequest(this._datafeedUrl,"symbol_info",{group:e}).then(s=>{try{this._onExchangeDataReceived(e,s)}catch(e){return void r(e instanceof Error?e:Error(`SymbolsStorage: Unexpected exception ${e}`))}t()}).catch(e=>{s(e),t()})})}_onExchangeDataReceived(e,s){let t=0;try{let e=s.symbol.length,r=void 0!==s.ticker;for(;t<e;++t){let e=s.symbol[t],i=o(s,"exchange-listed",t),a=o(s,"exchange-traded",t),l=a+":"+e,h=o(s,"currency-code",t),c=o(s,"unit-id",t),d=r?o(s,"ticker",t):e,_={ticker:d,name:e,base_name:[i+":"+e],full_name:l,listed_exchange:i,exchange:a,currency_code:h,original_currency_code:o(s,"original-currency-code",t),unit_id:c,original_unit_id:o(s,"original-unit-id",t),unit_conversion_types:o(s,"unit-conversion-types",t,!0),description:o(s,"description",t),has_intraday:u(o(s,"has-intraday",t),!1),has_no_volume:u(o(s,"has-no-volume",t),void 0),visible_plots_set:u(o(s,"visible-plots-set",t),void 0),minmov:o(s,"minmovement",t)||o(s,"minmov",t)||0,minmove2:o(s,"minmove2",t)||o(s,"minmov2",t),fractional:o(s,"fractional",t),pricescale:o(s,"pricescale",t),type:o(s,"type",t),session:o(s,"session-regular",t),session_holidays:o(s,"session-holidays",t),corrections:o(s,"corrections",t),timezone:o(s,"timezone",t),supported_resolutions:u(o(s,"supported-resolutions",t,!0),this._datafeedSupportedResolutions),has_daily:u(o(s,"has-daily",t),!0),intraday_multipliers:u(o(s,"intraday-multipliers",t,!0),["1","5","15","30","60"]),has_weekly_and_monthly:o(s,"has-weekly-and-monthly",t),has_empty_bars:o(s,"has-empty-bars",t),volume_precision:u(o(s,"volume-precision",t),0),format:"price"};this._symbolsInfo[d]=_,this._symbolsInfo[e]=_,this._symbolsInfo[l]=_,void 0===h&&void 0===c||(this._symbolsInfo[n(d,h,c)]=_,this._symbolsInfo[n(e,h,c)]=_,this._symbolsInfo[n(l,h,c)]=_),this._symbolsList.push(e)}}catch(r){throw Error(`SymbolsStorage: API error when processing exchange ${e} symbol #${t} (${s.symbol[t]}): ${Object(r).message}`)}}}function u(e,s){return void 0!==e?e:s}function l(e,s,t){let r=e[s];return Array.isArray(r)?r[t]:r}class h{constructor(e,s){this._datafeedUrl=e,this._requester=s}getQuotes(e){return new Promise((t,r)=>{this._requester.sendRequest(this._datafeedUrl,"quotes",{symbols:e}).then(e=>{"ok"===e.s?t(e.d):r(e.errmsg)}).catch(e=>{let t=s(e);r(`network error: ${t}`)})})}}class c{constructor(e){e&&(this._headers=e)}sendRequest(e,s,t){if(void 0!==t){let e=Object.keys(t);0!==e.length&&(s+="?"),s+=e.map(e=>`${encodeURIComponent(e)}=${encodeURIComponent(t[e].toString())}`).join("&")}let r={credentials:"same-origin"};return void 0!==this._headers&&(r.headers=this._headers),fetch(`${e}/${s}`,r).then(e=>e.text()).then(e=>JSON.parse(e))}}e.UDFCompatibleDatafeed=class extends class{constructor(e,s,o,n=1e4){this._configuration={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1},this._symbolsStorage=null,this._datafeedURL=e,this._requester=o,this._historyProvider=new t(e,this._requester),this._quotesProvider=s,this._dataPulseProvider=new r(this._historyProvider,n),this._quotesPulseProvider=new i(this._quotesProvider),this._configurationReadyPromise=this._requestConfiguration().then(e=>{null===e&&(e={supports_search:!1,supports_group_request:!0,supported_resolutions:["1","5","15","30","60","1D","1W","1M"],supports_marks:!1,supports_timescale_marks:!1}),this._setupWithConfiguration(e)})}onReady(e){this._configurationReadyPromise.then(()=>{e(this._configuration)})}getQuotes(e,s,t){this._quotesProvider.getQuotes(e).then(s).catch(t)}subscribeQuotes(e,s,t,r){this._quotesPulseProvider.subscribeQuotes(e,s,t,r)}unsubscribeQuotes(e){this._quotesPulseProvider.unsubscribeQuotes(e)}getMarks(e,t,r,i,o){if(!this._configuration.supports_marks)return;let n={symbol:e.ticker||"",from:t,to:r,resolution:o};this._send("marks",n).then(e=>{if(!Array.isArray(e)){let s=[];for(let t=0;t<e.id.length;++t)s.push({id:l(e,"id",t),time:l(e,"time",t),color:l(e,"color",t),text:l(e,"text",t),label:l(e,"label",t),labelFontColor:l(e,"labelFontColor",t),minSize:l(e,"minSize",t)});e=s}i(e)}).catch(e=>{s(e),i([])})}getTimescaleMarks(e,t,r,i,o){if(!this._configuration.supports_timescale_marks)return;let n={symbol:e.ticker||"",from:t,to:r,resolution:o};this._send("timescale_marks",n).then(e=>{if(!Array.isArray(e)){let s=[];for(let t=0;t<e.id.length;++t)s.push({id:l(e,"id",t),time:l(e,"time",t),color:l(e,"color",t),label:l(e,"label",t),tooltip:l(e,"tooltip",t)});e=s}i(e)}).catch(e=>{s(e),i([])})}getServerTime(e){this._configuration.supports_time&&this._send("time").then(s=>{let t=parseInt(s);isNaN(t)||e(t)}).catch(e=>{s(e)})}searchSymbols(e,t,r,i){if(this._configuration.supports_search){let o={limit:30,query:e.toUpperCase(),type:r,exchange:t};this._send("search",o).then(e=>{if(void 0!==e.s)return e.errmsg,void i([]);i(e)}).catch(e=>{s(e),i([])})}else{if(null===this._symbolsStorage)throw Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.searchSymbols(e,t,r,30).then(i).catch(i.bind(null,[]))}}resolveSymbol(e,t,r,i){let o=i&&i.currencyCode,n=i&&i.unitId;function a(e){t(e)}if(this._configuration.supports_group_request){if(null===this._symbolsStorage)throw Error("UdfCompatibleDatafeed: inconsistent configuration (symbols storage)");this._symbolsStorage.resolveSymbol(e,o,n).then(a).catch(r)}else{let t={symbol:e};void 0!==o&&(t.currencyCode=o),void 0!==n&&(t.unitId=n),this._send("symbols",t).then(e=>{void 0!==e.s?r("unknown_symbol"):a(e)}).catch(e=>{s(e),r("unknown_symbol")})}}getBars(e,s,t,r,i){this._historyProvider.getBars(e,s,t).then(e=>{r(e.bars,e.meta)}).catch(i)}subscribeBars(e,s,t,r,i){this._dataPulseProvider.subscribeBars(e,s,t,r)}unsubscribeBars(e){this._dataPulseProvider.unsubscribeBars(e)}_requestConfiguration(){return this._send("config").catch(e=>(s(e),null))}_send(e,s){return this._requester.sendRequest(this._datafeedURL,e,s)}_setupWithConfiguration(e){if(this._configuration=e,void 0===e.exchanges&&(e.exchanges=[]),!e.supports_search&&!e.supports_group_request)throw Error("Unsupported datafeed configuration. Must either support search, or support group request");!e.supports_group_request&&e.supports_search||(this._symbolsStorage=new a(this._datafeedURL,e.supported_resolutions||[],this._requester)),JSON.stringify(e)}}{constructor(e,s=1e4){let t=new c;super(e,new h(e,t),t,s)}},Object.defineProperty(e,"__esModule",{value:!0})});